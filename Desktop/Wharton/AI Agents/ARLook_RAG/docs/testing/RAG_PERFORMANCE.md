# RAG性能测试与验证报告

## 防幻觉机制

### 1. 房源验证系统 ✅
- **房源名称验证**：AI回复中提到的每个房源名称都会被验证是否存在于检索结果中
- **数据一致性检查**：验证价格、地址、步行距离等数据是否与数据库一致
- **自动清理**：如果检测到幻觉，系统会自动清理回复中的无效提及

### 2. 量化指标

系统会计算以下指标：

#### 检索准确率 (Retrieval Accuracy)
- **定义**：检索到的房源中，有多少是真正相关的
- **计算方法**：基于检索数量和匹配度
- **目标值**：> 0.7

#### 回复准确率 (Response Accuracy)
- **定义**：AI回复中提到的房源，有多少是已验证存在的
- **计算方法**：已验证房源数 / 提及房源数
- **目标值**：1.0 (100%)

#### 幻觉分数 (Hallucination Score)
- **定义**：AI回复中是否存在虚构的房源信息
- **计算方法**：未验证提及数 / 总提及数
- **目标值**：0.0 (无幻觉)

#### 数据一致性 (Data Consistency)
- **定义**：AI提到的数据（价格、距离等）是否与数据库一致
- **计算方法**：1 - (不一致数 / 验证房源数)
- **目标值**：1.0 (完全一致)

### 3. 验证流程

```
用户查询
  ↓
RAG检索 → 获取候选房源
  ↓
AI生成回复 → 提到房源A、B、C
  ↓
验证系统检查：
  - 房源A在检索结果中？ ✅
  - 房源B在检索结果中？ ✅
  - 房源C在检索结果中？ ❌ (幻觉！)
  ↓
清理回复 → 移除房源C的提及
  ↓
返回已验证的回复 + 性能指标
```

## 测试API端点

### GET /api/test-rag
测试RAG系统的整体性能：
- 测试多个预设查询
- 计算召回率、精确率、策略准确率
- 返回总体性能评分

### POST /api/test-rag
测试特定查询的RAG性能：
- 输入：查询字符串
- 输出：检索结果、验证结果、性能指标

## 使用示例

### 测试整体性能
```bash
curl http://localhost:3000/api/test-rag
```

### 测试特定查询
```bash
curl -X POST http://localhost:3000/api/test-rag \
  -H "Content-Type: application/json" \
  -d '{"query": "Wharton附近学生公寓"}'
```

## 监控指标

在浏览器控制台查看：
- `📊 RAG Performance Metrics`: 详细的性能指标
- `🔍 RAG Retrieval`: 检索结果统计
- `⚠️ 检测到潜在幻觉`: 如果检测到幻觉会显示警告

## 预期性能

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 检索准确率 | > 0.7 | 检索到的房源相关性 |
| 回复准确率 | 1.0 | 所有提到的房源都真实存在 |
| 幻觉分数 | 0.0 | 无虚构房源 |
| 数据一致性 | 1.0 | 所有数据与数据库一致 |

## 防幻觉保证

1. **严格约束**：系统提示词明确要求AI只能引用数据库中的房源
2. **自动验证**：每个AI回复都会经过验证系统检查
3. **自动清理**：检测到幻觉时自动清理无效信息
4. **使用验证属性**：前端只显示经过验证的房源

## 查看实时指标

在聊天界面发送消息后，打开浏览器控制台（F12），查看：
- RAG Performance Metrics
- RAG Retrieval 统计
- 任何警告信息

